<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello CommonJS!</title>
</head>
<body>


<script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//cdn.jsdelivr.net/sockjs/1.0.0/sockjs.min.js"></script>
<script src="vertx-eventbus.js"></script>
<script>
  var eb = new EventBus('/eventbus/');

  eb.onopen = function () {
    eb.registerHandler('feed', function (err, msg) {
      $('#log').prepend('<div>' + msg.body.now + '</div>');
    });
  };

  function sendMsg() {
    eb.send("callback","12312431")
  }
    // 实现小文件的一次性上传
  function check() {
      var objFile = document.getElementById("fileId");
      if (objFile.value == "") {
          alert("不能空")
      }
      console.log(objFile.files[0].size); // 文件字节数

      var files = $('#fileId').prop('files');//获取到文件列表
      if (files.length == 0) {
          alert('请选择文件');
      } else {

          // var options = DeliveryOptions().setCodecName("bytearray");

          // eb.send("fileData",files[0])

          var fileName = files[0].name
          console.log("文件名称---->"+fileName)
          var reader = new FileReader();//新建一个FileReader
          reader.readAsBinaryString(files[0])
          // reader.readAsText(files[0], "UTF-8");//读取文件
          reader.onload = function (evt) { //读取完文件之后会回来这里
            /*  var fileString = evt.target.result; // 读取文件内容
              console.log(fileString)
              var data = {"data":fileString}
              console.log(data)
              var dataView = new DataView(fileString);
              var jsond = {"data":dataView}
              eb.send("fileData",jsond)*/

              // eb.send("fileData",data,options)
          }
          reader.onloadend=function() {
                // 这个事件在读取结束后，无论成功或者失败都会触发
              if (reader.error) {
                  console.log(reader.error);
              } else {
                  var result = reader.result
                  var data = {"fileName":fileName,"data":result}
                  eb.send("fileData",data)
              }
          }
          reader.onprogress= function (item) {

              console.log(item.data)
          }

          return;
      }
  }

  function ab2str(buf) {
      return String.fromCharCode.apply(null, new Uint16Array(buf));
  }

  function mulitUpload() {
      var objFile = document.getElementById("fileId");
      if (objFile.value == "") {
          alert("不能空")
      }
      console.log(objFile.files[0].size); // 文件字节数

      var files = $('#fileId').prop('files');//获取到文件列表
      if (files.length == 0) {
          alert('请选择文件');
      } else {

          var fileName = files[0].name
          console.log("文件名称---->"+fileName)
          var reader = new FileReader();//新建一个FileReader
          reader.readAsArrayBuffer(files[0])
          reader.onloadend=function() {
              // 这个事件在读取结束后，无论成功或者失败都会触发
              if (reader.error) {
                  console.log(reader.error);
              } else {
                  var buffer = reader.result
                  var view= new Int8Array(buffer)
                  var array =Array.prototype.slice.call(view);
                  var data = {"fileName":fileName,"data":array}
                  eb.send("mulitUpload",data)
              }
          }
          reader.onprogress= function (item) {

              console.log(item.data)
          }

          return;
      }
  }

</script>
<div>
    <button onclick="sendMsg()">send</button>
</div>

<div>
    <div>
        上传文件 ： <input type="file" name = "file" id = "fileId" />

        <button  type = "submit" name = "btn" value = "提交" id = "btnId" onclick="mulitUpload()" /> 提交
    </div>
</div>

<div>
    <div id="log"></div>
</div>
</body>
</html>
